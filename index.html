<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History Unchained | Advanced Temporal Interface</title>
    
    <!-- External Resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Inter:wght@300;400;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE VARIABLES (Enhanced) --- */
        :root {
            --bg-deep: #050505;
            --bg-panel: #0f0f11;
            --bg-card: rgba(30, 30, 35, 0.85);
            --accent-gold: #cfaa6e;
            --accent-gold-dim: rgba(207, 170, 110, 0.1);
            --accent-red: #ff3e3e;
            --accent-blue: #2e8cff;
            --accent-green: #10b981;
            --text-main: #e0e0e0;
            --text-dim: #8888aa;
            --border-light: rgba(255, 255, 255, 0.15);
            --font-display: 'Cinzel', serif;
            --font-ui: 'Inter', sans-serif;
            --font-mono: 'Share Tech Mono', monospace;
            --ease-expo: cubic-bezier(0.19, 1, 0.22, 1);
            --glow-gold: 0 0 20px rgba(207, 170, 110, 0.5);
            --glow-blue: 0 0 20px rgba(46, 140, 255, 0.5);
        }

        /* --- RESET & BASE --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            background: radial-gradient(ellipse at center, #0a0a0f 0%, #050505 100%);
        }

        /* --- UTILITY CLASSES --- */
        .hidden { display: none !important; }
        .gold-text { color: var(--accent-gold); text-shadow: var(--glow-gold); }
        .mono { font-family: var(--font-mono); letter-spacing: 1px; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); }
        
        /* --- LOADING SCREEN (Cinematic) --- */
        #loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.8s var(--ease-expo);
        }
        .loader-ring {
            width: 100px; height: 100px;
            border: 3px solid transparent;
            border-top: 3px solid var(--accent-gold);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            position: relative;
        }
        .loader-ring::before {
            content: ''; position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 2px solid transparent;
            border-bottom: 2px solid var(--accent-red);
            border-radius: 50%;
            animation: spin 2s linear infinite reverse;
        }
        .loader-text {
            margin-top: 30px;
            font-family: var(--font-display);
            letter-spacing: 8px;
            font-size: 1.5rem;
            color: var(--accent-gold);
            animation: pulse 2s infinite;
            text-transform: uppercase;
        }

        /* --- NAVIGATION (Enhanced) --- */
        nav {
            position: fixed;
            top: 0; width: 100%;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(5, 5, 5, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-light);
            z-index: 1000;
            transition: all 0.3s;
        }
        .nav-brand {
            font-family: var(--font-display);
            font-size: 1.8rem;
            font-weight: 900;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-transform: uppercase;
        }
        .nav-icon {
            width: 12px; height: 12px;
            background: var(--accent-red);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--accent-red);
            animation: pulse 1.5s infinite;
        }
        .nav-links { display: flex; gap: 40px; }
        .nav-btn {
            background: none; border: none;
            color: var(--text-dim);
            font-family: var(--font-ui);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            padding: 8px 16px;
        }
        .nav-btn::after {
            content: ''; position: absolute;
            bottom: 0; left: 50%; width: 0%; height: 2px;
            background: linear-gradient(90deg, var(--accent-red), var(--accent-gold));
            transition: all 0.4s var(--ease-expo);
            transform: translateX(-50%);
        }
        .nav-btn:hover, .nav-btn.active { 
            color: var(--text-main);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        .nav-btn:hover::after, .nav-btn.active::after { 
            width: 80%;
        }

        /* --- LANDING HERO (Cinematic) --- */
        #landing {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
            padding-top: 80px;
        }
        #bg-canvas { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            z-index: -1; 
            opacity: 0.7;
        }
        .hero-title {
            font-family: var(--font-display);
            font-size: 6rem;
            line-height: 1.1;
            background: linear-gradient(to bottom, #ffffff, #cfaa6e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
            opacity: 0; transform: translateY(50px);
            animation: heroEnter 1.5s var(--ease-expo) 0.5s forwards;
            text-transform: uppercase;
            letter-spacing: 4px;
        }
        .hero-subtitle {
            font-family: var(--font-mono);
            color: var(--accent-blue);
            font-size: 1.2rem;
            margin-bottom: 60px;
            opacity: 0;
            animation: heroEnter 1.5s var(--ease-expo) 0.8s forwards;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        .hero-stats {
            display: flex; 
            gap: 60px;
            opacity: 0;
            animation: heroEnter 1.5s var(--ease-expo) 1.1s forwards;
        }
        .stat-item h3 { 
            font-size: 3.5rem; 
            color: white; 
            font-family: var(--font-display);
            background: linear-gradient(to right, var(--accent-gold), var(--accent-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-item p { 
            font-size: 0.9rem; 
            color: var(--text-dim); 
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 10px;
        }
        
        /* --- MAIN CONTAINER --- */
        #main-app {
            min-height: 100vh;
        }

        /* --- CONTROLS BAR --- */
        #controls {
            background: var(--bg-panel);
            padding: 20px 40px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            position: sticky;
            top: 80px;
            z-index: 900;
            backdrop-filter: blur(10px);
        }
        .control-select {
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--border-light);
            color: var(--text-main);
            padding: 10px 20px;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 180px;
        }
        .control-select:hover, .control-select:focus { 
            border-color: var(--accent-gold);
            box-shadow: var(--glow-gold);
        }
        
        /* --- TIMELINE SECTION (Enhanced) --- */
        .section-header {
            text-align: center;
            padding: 80px 20px 40px;
        }
        .section-title {
            font-family: var(--font-display);
            font-size: 3.5rem;
            margin-bottom: 20px;
            background: linear-gradient(to right, var(--accent-gold), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        .section-subtitle {
            font-size: 1.2rem;
            color: var(--text-dim);
            max-width: 800px;
            margin: 0 auto;
            font-family: var(--font-mono);
        }

        #timeline-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px 100px;
            position: relative;
            min-height: 100vh;
        }
        /* Central Line */
        .timeline-line {
            position: absolute;
            top: 0; bottom: 0; left: 50%;
            width: 2px;
            background: linear-gradient(to bottom, 
                transparent, 
                var(--accent-gold), 
                var(--accent-blue), 
                var(--accent-red),
                transparent);
            transform: translateX(-50%);
        }
        
        /* Event Nodes */
        .event-node {
            width: 45%;
            margin-bottom: 80px;
            position: relative;
            opacity: 0;
            transform: translateY(40px);
            transition: all 0.8s var(--ease-expo);
        }
        .event-node.visible { 
            opacity: 1; 
            transform: translateY(0); 
        }
        
        .event-node.left { 
            text-align: right; 
            padding-right: 60px; 
        }
        .event-node.right { 
            text-align: left; 
            margin-left: 55%; 
            padding-left: 60px; 
        }

        /* The Dot */
        .event-node::before {
            content: '';
            position: absolute;
            top: 30px;
            width: 16px; 
            height: 16px;
            background: var(--bg-deep);
            border: 3px solid var(--accent-gold);
            border-radius: 50%;
            z-index: 2;
            transition: all 0.4s;
            box-shadow: 0 0 0 0 rgba(207, 170, 110, 0);
        }
        .event-node.left::before { right: -8px; }
        .event-node.right::before { left: -8px; }
        
        .event-node:hover::before {
            background: var(--accent-gold);
            box-shadow: 0 0 20px var(--accent-gold);
            transform: scale(1.3);
        }

        /* Event Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            padding: 30px;
            position: relative;
            transition: all 0.4s var(--ease-expo);
            backdrop-filter: blur(5px);
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: var(--accent-gold);
            box-shadow: 0 20px 50px rgba(0,0,0,0.7);
        }
        .card-year {
            font-family: var(--font-display);
            font-size: 3rem;
            color: var(--text-dim);
            opacity: 0.3;
            margin-bottom: -20px;
            display: block;
            pointer-events: none;
            font-weight: 900;
        }
        .card-title { 
            font-size: 1.6rem; 
            margin-bottom: 15px; 
            color: var(--text-main);
            font-family: var(--font-display);
        }
        .card-desc { 
            font-size: 1rem; 
            color: #aaa; 
            line-height: 1.7; 
            margin-bottom: 20px;
            font-family: var(--font-ui);
        }
        .card-tags { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap;
        }
        .event-node.right .card-tags { justify-content: flex-start; }
        .event-node.left .card-tags { justify-content: flex-end; }
        
        .tag {
            font-size: 0.8rem;
            font-family: var(--font-mono);
            padding: 6px 12px;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        .tag:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }
        .tag.arc { 
            color: var(--accent-red); 
            border-color: rgba(255, 62, 62, 0.3);
            background: rgba(255, 62, 62, 0.1);
        }
        .tag.ww1 { color: #3B82F6; border-color: rgba(59, 130, 246, 0.3); }
        .tag.ww2 { color: #EF4444; border-color: rgba(239, 68, 68, 0.3); }
        .tag.napoleonic { color: #8B5CF6; border-color: rgba(139, 92, 246, 0.3); }
        .tag.coldwar { color: #10B981; border-color: rgba(16, 185, 129, 0.3); }

        /* --- MAP SECTION (Leaflet + Canvas Overlay) --- */
        #map-section {
            height: 90vh;
            position: relative;
            background: #080808;
            overflow: hidden;
            border-top: 1px solid var(--border-light);
            border-bottom: 1px solid var(--border-light);
        }
        #world-map {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }
        #map-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 2;
        }
        .map-ui {
            position: absolute;
            bottom: 40px; left: 40px;
            background: rgba(5, 5, 5, 0.85);
            border: 1px solid var(--border-light);
            padding: 20px;
            max-width: 350px;
            backdrop-filter: blur(10px);
            z-index: 3;
        }
        .map-legend {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-dim);
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* --- AI SECTION (CRT Terminal) --- */
        #ai-section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 80px 20px;
            background: radial-gradient(ellipse at center, #0a0a0f 0%, #050505 100%);
            position: relative;
            overflow: hidden;
        }
        .ai-container {
            width: 100%; 
            max-width: 1000px;
            background: var(--bg-panel);
            border: 1px solid var(--border-light);
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
        }
        /* CRT Scanline effect */
        .ai-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15) 0px,
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 2;
            opacity: 0.3;
        }
        .ai-container::after {
            content: '';
            position: absolute;
            top: 0; left: 0; 
            width: 100%; height: 100%;
            background: linear-gradient(
                rgba(18, 16, 16, 0) 50%,
                rgba(0, 0, 0, 0.25) 50%
            ), linear-gradient(
                90deg,
                rgba(255, 0, 0, 0.06),
                rgba(0, 255, 0, 0.02),
                rgba(0, 0, 255, 0.06)
            );
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 3;
        }
        .ai-screen {
            background: #0a0a0a;
            padding: 40px;
            height: 600px;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }
        .ai-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #333; 
            padding-bottom: 15px;
        }
        .ai-title {
            font-family: var(--font-mono);
            color: var(--accent-gold);
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        .ai-status {
            font-family: var(--font-mono); 
            color: var(--accent-green); 
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .ai-log {
            flex: 1; 
            overflow-y: auto;
            font-family: var(--font-mono);
            font-size: 1rem;
            color: #d4d4d4;
            margin-bottom: 25px;
            padding-right: 15px;
            line-height: 1.6;
        }
        /* Custom Scrollbar */
        .ai-log::-webkit-scrollbar { width: 8px; }
        .ai-log::-webkit-scrollbar-track { background: #111; }
        .ai-log::-webkit-scrollbar-thumb { 
            background: #333; 
            border-radius: 4px;
        }
        
        .ai-input-group { 
            display: flex; 
            gap: 15px;
            margin-top: 20px;
        }
        .ai-input {
            flex: 1; 
            background: #111;
            border: 1px solid #333; 
            color: #fff;
            padding: 15px 20px; 
            font-family: var(--font-mono);
            font-size: 1rem;
            transition: all 0.3s;
        }
        .ai-input:focus { 
            border-color: var(--accent-blue);
            box-shadow: var(--glow-blue);
            outline: none;
        }
        .btn-glow {
            background: transparent;
            border: 1px solid var(--accent-blue);
            color: var(--accent-blue);
            padding: 0 40px;
            font-family: var(--font-mono);
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
        }
        .btn-glow:hover {
            background: var(--accent-blue);
            color: #000;
            box-shadow: 0 0 30px var(--accent-blue);
            transform: translateY(-2px);
        }

        /* --- EVENTS GRID --- */
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
            padding: 60px 20px;
        }
        .event-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.4s var(--ease-expo);
            cursor: pointer;
        }
        .event-card:hover {
            transform: translateY(-10px);
            border-color: var(--accent-gold);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        .event-image {
            height: 200px;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-red));
            position: relative;
        }
        .event-year {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
        }
        .event-content {
            padding: 25px;
        }

        /* --- MODAL (Enhanced) --- */
        .modal-backdrop {
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: flex; 
            justify-content: center; 
            align-items: center;
            opacity: 0; 
            pointer-events: none;
            transition: opacity 0.5s var(--ease-expo);
            backdrop-filter: blur(10px);
        }
        .modal-backdrop.active { 
            opacity: 1; 
            pointer-events: auto; 
        }
        
        .modal {
            background: #141416;
            width: 90%; 
            max-width: 900px;
            max-height: 85vh;
            border: 1px solid var(--border-light);
            transform: translateY(60px) scale(0.95);
            transition: all 0.5s var(--ease-expo);
            overflow-y: auto;
            position: relative;
            border-radius: 8px;
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.8);
        }
        .modal-backdrop.active .modal { 
            transform: translateY(0) scale(1); 
        }
        
        .modal-header {
            padding: 40px;
            border-bottom: 1px solid #222;
            background: linear-gradient(135deg, #1a1a1d 0%, #141416 100%);
            position: relative;
        }
        .modal-body { 
            padding: 40px; 
            color: #ccc; 
            line-height: 1.7;
            font-size: 1.1rem;
        }
        .close-modal {
            position: absolute; 
            top: 20px; 
            right: 20px;
            background: none; 
            border: none; 
            color: #666;
            font-size: 2.5rem; 
            cursor: pointer; 
            transition: all 0.3s;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .close-modal:hover { 
            color: var(--accent-red); 
            transform: rotate(90deg);
        }

        /* Decision Tree */
        .dec-tree { 
            margin-top: 40px; 
            border-top: 1px dashed #333; 
            padding-top: 30px; 
        }
        .dec-btn {
            display: block; 
            width: 100%;
            background: #1f1f22; 
            border: 1px solid #333;
            padding: 20px; 
            margin-bottom: 15px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
            color: #aaa;
            font-family: var(--font-mono);
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }
        .dec-btn:hover { 
            background: #2a2a2e; 
            color: #fff; 
            border-left: 5px solid var(--accent-gold);
            transform: translateX(5px);
        }
        .dec-result {
            background: rgba(0, 0, 0, 0.4); 
            border: 1px solid var(--accent-red);
            padding: 25px; 
            margin-top: 15px; 
            display: none;
            color: #ffcccc;
            border-radius: 4px;
            animation: fadeIn 0.5s;
        }

        /* --- FOOTER --- */
        footer {
            background: var(--bg-deep);
            padding: 60px 20px;
            text-align: center;
            border-top: 1px solid var(--border-light);
        }
        .footer-logo {
            font-family: var(--font-display);
            font-size: 2.5rem;
            margin-bottom: 30px;
            background: linear-gradient(to right, var(--accent-gold), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        /* --- ANIMATIONS --- */
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        @keyframes blink { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes heroEnter { 
            to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .cursor-blink { 
            animation: blink 1s infinite; 
            color: var(--accent-blue); 
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .hero-title { font-size: 4rem; }
            .nav-links { gap: 20px; }
            .event-node { width: 100%; text-align: left !important; margin-left: 60px !important; padding-right: 0 !important; }
            .event-node::before { left: -34px !important; }
            .timeline-line { left: 30px; }
        }
        @media (max-width: 768px) {
            .hero-title { font-size: 3rem; }
            .nav-links { display: none; }
            .hero-stats { flex-direction: column; gap: 30px; }
            .section-title { font-size: 2.5rem; }
            .events-grid { grid-template-columns: 1fr; }
            .ai-screen { padding: 20px; }
        }
    </style>
</head>
<body>

    <!-- LOADING SCREEN -->
    <div id="loader">
        <div class="loader-ring"></div>
        <div class="loader-text">CHRONICLE INTERFACE</div>
        <div style="margin-top: 20px; color: var(--text-dim); font-family: var(--font-mono);">
            Loading historical database...
        </div>
    </div>

    <!-- NAVIGATION -->
    <nav>
        <div class="nav-brand">
            <div class="nav-icon"></div>
            HISTORY UNCHAINED
        </div>
        <div class="nav-links">
            <button class="nav-btn active" onclick="app.view('landing')">Origin</button>
            <button class="nav-btn" onclick="app.view('timeline')">Timeline</button>
            <button class="nav-btn" onclick="app.view('map')">Global Map</button>
            <button class="nav-btn" onclick="app.view('ai')">AI Engine</button>
            <button class="nav-btn" onclick="app.view('events')">Events Database</button>
        </div>
    </nav>

    <!-- LANDING VIEW -->
    <section id="view-landing">
        <canvas id="bg-canvas"></canvas>
        <div id="landing">
            <h1 class="hero-title">CHRONICLES<br>UNCHAINED</h1>
            <p class="hero-subtitle">INTERACTIVE HISTORICAL SIMULATION // V.3.0</p>
            <div class="hero-stats">
                <div class="stat-item">
                    <h3 id="stat-count">0</h3>
                    <p>Historical Events</p>
                </div>
                <div class="stat-item">
                    <h3>150+</h3>
                    <p>WWI-WWII Database</p>
                </div>
                <div class="stat-item">
                    <h3>AI</h3>
                    <p>Powered Analysis</p>
                </div>
            </div>
            <div style="margin-top: 80px; opacity:0; animation: heroEnter 1s 1.5s forwards;">
                <button class="btn-glow" style="padding: 20px 50px; font-size: 1.1rem;" onclick="app.view('timeline')">
                    Enter Simulation
                </button>
            </div>
        </div>
    </section>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
        
        <!-- CONTROLS BAR -->
        <div id="controls">
            <select class="control-select" id="filter-era" onchange="app.filter()">
                <option value="all">All Eras</option>
                <option value="WWI">World War I</option>
                <option value="WWII">World War II</option>
                <option value="Napoleonic">Napoleonic Era</option>
                <option value="Cold War">Cold War</option>
                <option value="Modern">Modern Era</option>
            </select>
            <select class="control-select" id="filter-arc" onchange="app.filter()">
                <option value="all">All Narratives</option>
                <option value="Napoleon">Napoleon Bonaparte</option>
                <option value="Hitler">Adolf Hitler</option>
                <option value="Che">Che Guevara</option>
                <option value="Churchill">Winston Churchill</option>
            </select>
            <select class="control-select" id="filter-theme" onchange="app.filter()">
                <option value="all">All Themes</option>
                <option value="war">War & Conflict</option>
                <option value="revolution">Revolution</option>
                <option value="politics">Politics</option>
                <option value="technology">Technology</option>
                <option value="culture">Culture</option>
            </select>
            <button class="btn-glow" onclick="app.resetFilters()" style="padding: 10px 20px;">
                Reset Filters
            </button>
        </div>

        <!-- TIMELINE VIEW -->
        <div id="view-timeline">
            <div class="section-header">
                <h2 class="section-title">Historical Timeline</h2>
                <p class="section-subtitle">Scroll through centuries of history with animated events and detailed analysis</p>
            </div>
            <div id="timeline-container">
                <div class="timeline-line"></div>
                <!-- Timeline events injected here -->
            </div>
        </div>

        <!-- MAP VIEW -->
        <div id="view-map" class="hidden">
            <div class="section-header">
                <h2 class="section-title">World Events Map</h2>
                <p class="section-subtitle">Visualize historical events geographically with interactive tracking</p>
            </div>
            <div id="map-section">
                <div id="world-map"></div>
                <canvas id="map-overlay"></canvas>
                <div class="map-ui">
                    <h4 class="mono gold-text">GEOSPATIAL TRACKER</h4>
                    <p style="font-size: 0.9rem; color: var(--text-dim); margin-top: 10px;">
                        Visualizing 150+ historical events with trajectory analysis
                    </p>
                    <div class="map-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3B82F6;"></div>
                            <span>World War I Events</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #EF4444;"></div>
                            <span>World War II Events</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #8B5CF6;"></div>
                            <span>Napoleonic Era</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10B981;"></div>
                            <span>Cold War Events</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI VIEW -->
        <div id="view-ai" class="hidden">
            <section id="ai-section">
                <div class="ai-container">
                    <div class="ai-screen">
                        <div class="ai-header">
                            <span class="ai-title">TEMPORAL_AI_CORE // HISTORY UNCHAINED</span>
                            <span class="ai-status">
                                <div class="status-dot"></div>
                                ONLINE
                            </span>
                        </div>
                        <div class="ai-log" id="ai-log">
                            <div style="color: var(--accent-gold);">>>> SYSTEM INITIALIZED</div>
                            <div style="color: #666; margin-top: 10px;">Historical database loaded: 150+ events across 5 eras</div>
                            <div style="color: var(--accent-blue); margin-top: 15px;">> Ready for temporal simulations.</div>
                            <div style="color: #888; margin-top: 10px;">Ask "What if?" scenarios or request historical analysis.</div>
                        </div>
                        <div class="ai-input-group">
                            <input type="text" class="ai-input" id="ai-input" 
                                   placeholder="Enter historical query (e.g., 'What if Germany won WWI?')..." 
                                   autocomplete="off"
                                   onkeypress="if(event.key === 'Enter') app.askAI()">
                            <button class="btn-glow" onclick="app.askAI()">Execute</button>
                            <button class="btn-glow" onclick="app.toggleVoice()" id="voice-btn" style="padding: 0 20px;">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- EVENTS DATABASE VIEW -->
        <div id="view-events" class="hidden">
            <div class="section-header">
                <h2 class="section-title">Historical Events Database</h2>
                <p class="section-subtitle">Comprehensive archive of 150+ pivotal moments in history</p>
            </div>
            <div class="events-grid" id="events-grid">
                <!-- Event cards injected here -->
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal-backdrop" id="modal-backdrop" onclick="app.closeModal(event)">
        <div class="modal">
            <button class="close-modal" onclick="app.forceCloseModal()">&times;</button>
            <div class="modal-header">
                <h2 id="m-title" style="font-family: var(--font-display); color: var(--accent-gold); font-size: 2.5rem;"></h2>
                <div id="m-meta" class="mono" style="color: var(--text-dim); margin-top: 10px;">
                    <span id="m-year"></span> | <span id="m-era"></span> | <span id="m-arc"></span>
                </div>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 40px; margin-bottom: 40px;">
                    <div>
                        <h3 style="color: var(--accent-gold); margin-bottom: 15px;">Event Description</h3>
                        <p id="m-desc" style="font-size: 1.1rem; line-height: 1.8;"></p>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px;">
                        <h3 style="color: var(--accent-blue); margin-bottom: 15px;">Key Data</h3>
                        <div id="m-data"></div>
                    </div>
                </div>
                
                <div id="m-decisions" class="dec-tree">
                    <h3 style="color: var(--accent-red); margin-bottom: 20px;">
                        <i class="fas fa-code-branch"></i> Alternative History Scenarios
                    </h3>
                    <div id="m-dec-list"></div>
                    <div id="m-dec-result" class="dec-result"></div>
                </div>
                
                <div style="margin-top: 40px; border-top: 1px solid #222; padding-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <span class="mono" style="font-size: 0.8rem; color: #555;">EVENT ID: <span id="m-id">000</span></span>
                    <div style="display: flex; gap: 15px;">
                        <button class="btn-glow" style="padding: 12px 25px; font-size: 0.9rem;" onclick="app.speak()">
                            <i class="fas fa-volume-up"></i> Audio Briefing
                        </button>
                        <button class="btn-glow" style="padding: 12px 25px; font-size: 0.9rem; background: transparent; border-color: var(--accent-gold); color: var(--accent-gold);" 
                                onclick="app.bookmarkEvent()" id="bookmark-btn">
                            <i class="fas fa-bookmark"></i> Bookmark
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer>
        <div class="footer-logo">HISTORY UNCHAINED</div>
        <p style="color: var(--text-dim); max-width: 800px; margin: 0 auto 30px; line-height: 1.8;">
            An advanced historical simulation platform combining comprehensive databases, 
            AI-powered analysis, and interactive visualizations. Explore what could have been.
        </p>
        <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 40px;">
            <a href="#" style="color: var(--text-dim); font-size: 1.2rem; transition: color 0.3s;" onmouseover="this.style.color='var(--accent-gold)'" onmouseout="this.style.color='var(--text-dim)'">
                <i class="fab fa-github"></i>
            </a>
            <a href="#" style="color: var(--text-dim); font-size: 1.2rem; transition: color 0.3s;" onmouseover="this.style.color='var(--accent-gold)'" onmouseout="this.style.color='var(--text-dim)'">
                <i class="fab fa-twitter"></i>
            </a>
            <a href="#" style="color: var(--text-dim); font-size: 1.2rem; transition: color 0.3s;" onmouseover="this.style.color='var(--accent-gold)'" onmouseout="this.style.color='var(--text-dim)'">
                <i class="fab fa-discord"></i>
            </a>
        </div>
        <p style="color: var(--text-dim); font-size: 0.9rem; font-family: var(--font-mono);">
            &copy; 2024 History Unchained. Educational Use Only. Version 3.0
        </p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        /* --- ENHANCED AUDIO ENGINE --- */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const sfx = {
            hover: () => {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.03, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            },
            click: () => {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const osc1 = audioCtx.createOscillator();
                const osc2 = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc1.connect(gain);
                osc2.connect(gain);
                gain.connect(audioCtx.destination);
                
                osc1.type = 'sine';
                osc2.type = 'triangle';
                osc1.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc2.frequency.setValueAtTime(800, audioCtx.currentTime);
                
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
                
                osc1.start();
                osc2.start();
                osc1.stop(audioCtx.currentTime + 0.2);
                osc2.stop(audioCtx.currentTime + 0.2);
            },
            type: () => {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'square';
                osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.02, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.05);
            }
        };

        /* --- COMPREHENSIVE DATABASE --- */
        const historicalEvents = [
            // Napoleon Arc (15 events)
            {
                id: 1,
                title: "The French Revolution",
                year: 1789,
                date: "July 14, 1789",
                description: "The storming of the Bastille marks the beginning of the French Revolution.",
                detailed: "The French Revolution was a period of radical political and societal change in France that began with the Estates General of 1789 and ended with the formation of the French Consulate in November 1799. Napoleon Bonaparte rose to prominence during these turbulent times.",
                location: { lat: 48.8534, lng: 2.3488, name: "Paris, France" },
                era: "18th",
                arc: "Napoleon",
                themes: ["Revolution", "Politics", "Social Change"],
                casualties: 40000,
                significance: 10,
                decisionPoints: [
                    { title: "Support the Royalists", outcome: "Monarchy preserved, no Napoleonic era" },
                    { title: "Support the Republic", outcome: "Historical path leading to Napoleon's rise" }
                ],
                tags: ["napoleon", "french-revolution", "bastille"],
                color: "#8B5CF6"
            },
            {
                id: 2,
                title: "Battle of Austerlitz",
                year: 1805,
                date: "December 2, 1805",
                description: "Napoleon's greatest victory, defeating the combined forces of Russia and Austria.",
                detailed: "The Battle of Austerlitz, also known as the Battle of the Three Emperors, was one of the most important and decisive engagements of the Napoleonic Wars. Napoleon's Grande Armée defeated a larger Russian and Austrian army.",
                location: { lat: 49.1408, lng: 16.7598, name: "Austerlitz, Czech Republic" },
                era: "Napoleonic",
                arc: "Napoleon",
                themes: ["War", "Tactics", "Leadership"],
                casualties: 27000,
                significance: 9,
                decisionPoints: [
                    { title: "Retreat to defensive position", outcome: "Limited victory, continued conflict" },
                    { title: "Flanking maneuver", outcome: "Historical decisive victory" }
                ],
                tags: ["napoleon", "austerlitz", "military-genius"],
                color: "#8B5CF6"
            },
            // Hitler Arc (15 events)
            {
                id: 21,
                title: "Beer Hall Putsch",
                year: 1923,
                date: "November 8-9, 1923",
                description: "Hitler's failed coup attempt in Munich.",
                detailed: "The Beer Hall Putsch was a failed coup d'état by the Nazi Party leader Adolf Hitler, Generalquartiermeister Erich Ludendorff and other Kampfbund leaders in Munich, Bavaria, on 8–9 November 1923.",
                location: { lat: 48.1351, lng: 11.5820, name: "Munich, Germany" },
                era: "Interwar",
                arc: "Hitler",
                themes: ["Politics", "Coup", "Nazism"],
                casualties: 16,
                significance: 8,
                decisionPoints: [
                    { title: "Avoid confrontation", outcome: "Hitler remains obscure" },
                    { title: "Proceed with putsch", outcome: "Historical path, imprisonment, Mein Kampf" }
                ],
                tags: ["hitler", "nazi", "beer-hall-putsch"],
                color: "#EF4444"
            },
            {
                id: 22,
                title: "Invasion of Poland",
                year: 1939,
                date: "September 1, 1939",
                description: "Beginning of World War II in Europe.",
                detailed: "The invasion of Poland marked the beginning of World War II in Europe. The German invasion began on 1 September 1939, one week after the signing of the Molotov–Ribbentrop Pact, while the Soviet invasion commenced on 17 September.",
                location: { lat: 52.2297, lng: 21.0122, name: "Warsaw, Poland" },
                era: "WWII",
                arc: "Hitler",
                themes: ["War", "Invasion", "Blitzkrieg"],
                casualties: 66000,
                significance: 10,
                decisionPoints: [
                    { title: "Diplomatic solution", outcome: "WWII delayed or prevented" },
                    { title: "Full-scale invasion", outcome: "Historical: Global war begins" }
                ],
                tags: ["hitler", "wwii", "poland", "invasion"],
                color: "#EF4444"
            },
            // Che Guevara Arc (10 events)
            {
                id: 41,
                title: "Cuban Revolution Triumphs",
                year: 1959,
                date: "January 1, 1959",
                description: "Fidel Castro and Che Guevara enter Havana in victory.",
                detailed: "After years of guerrilla warfare, Fidel Castro's 26th of July Movement successfully overthrew the government of Cuban dictator Fulgencio Batista. Che Guevara played a crucial role as a military commander and ideological leader.",
                location: { lat: 23.1136, lng: -82.3666, name: "Havana, Cuba" },
                era: "Cold War",
                arc: "Che",
                themes: ["Revolution", "Guerrilla Warfare", "Socialism"],
                casualties: 5000,
                significance: 9,
                decisionPoints: [
                    { title: "Accept amnesty offer", outcome: "Guevara becomes diplomat" },
                    { title: "Continue revolution", outcome: "Historical: Socialist state established" }
                ],
                tags: ["che-guevara", "cuban-revolution", "castro"],
                color: "#10B981"
            },
            // WW1 Events (30 events)
            {
                id: 61,
                title: "Assassination of Archduke Franz Ferdinand",
                year: 1914,
                date: "June 28, 1914",
                description: "The spark that ignited World War I.",
                detailed: "Archduke Franz Ferdinand of Austria and his wife Sophie were assassinated by Gavrilo Princip, a Bosnian Serb nationalist. The assassination triggered events leading to World War I.",
                location: { lat: 43.8563, lng: 18.4131, name: "Sarajevo, Bosnia" },
                era: "WWI",
                arc: "none",
                themes: ["Assassination", "Politics", "War"],
                casualties: 2,
                significance: 10,
                decisionPoints: [
                    { title: "Driver takes correct route", outcome: "Assassination failed, WW1 delayed" },
                    { title: "Historical route", outcome: "WW1 begins as historical" }
                ],
                tags: ["wwi", "assassination", "sarajevo"],
                color: "#3B82F6"
            },
            {
                id: 62,
                title: "Battle of the Somme",
                year: 1916,
                date: "July 1 - November 18, 1916",
                description: "One of the bloodiest battles in human history.",
                detailed: "The Battle of the Somme was fought by the armies of the British Empire and French Third Republic against the German Empire. More than three million men fought in the battle and one million were wounded or killed.",
                location: { lat: 50.01, lng: 2.69, name: "Somme, France" },
                era: "WWI",
                arc: "none",
                themes: ["War", "Trench Warfare", "Attrition"],
                casualties: 1000000,
                significance: 9,
                decisionPoints: [
                    { title: "Cancel offensive", outcome: "Stalemate continues, different peace terms" },
                    { title: "Proceed with attack", outcome: "Historical: Massive casualties, no breakthrough" }
                ],
                tags: ["wwi", "somme", "trench-warfare"],
                color: "#3B82F6"
            },
            // WW2 Events (30 events)
            {
                id: 101,
                title: "Pearl Harbor Attack",
                year: 1941,
                date: "December 7, 1941",
                description: "Japanese surprise attack brings USA into WWII.",
                detailed: "The attack on Pearl Harbor was a surprise military strike by the Imperial Japanese Navy Air Service upon the United States against the naval base at Pearl Harbor in Honolulu, Territory of Hawaii.",
                location: { lat: 21.3445, lng: -157.9748, name: "Pearl Harbor, Hawaii" },
                era: "WWII",
                arc: "none",
                themes: ["War", "Surprise Attack", "Naval Warfare"],
                casualties: 2403,
                significance: 10,
                decisionPoints: [
                    { title: "Prevent attack with diplomacy", outcome: "USA enters war later" },
                    { title: "Attack as planned", outcome: "Historical: USA enters WWII immediately" }
                ],
                tags: ["wwii", "pearl-harbor", "usa"],
                color: "#EF4444"
            },
            {
                id: 102,
                title: "D-Day: Normandy Landings",
                year: 1944,
                date: "June 6, 1944",
                description: "Allied invasion of Nazi-occupied Europe.",
                detailed: "The Normandy landings were the landing operations and associated airborne operations on Tuesday, 6 June 1944 of the Allied invasion of Normandy in Operation Overlord during World War II.",
                location: { lat: 49.4144, lng: -0.8322, name: "Normandy, France" },
                era: "WWII",
                arc: "none",
                themes: ["War", "Invasion", "Amphibious Assault"],
                casualties: 10000,
                significance: 10,
                decisionPoints: [
                    { title: "Postpone due to weather", outcome: "German defenses strengthened" },
                    { title: "Proceed with invasion", outcome: "Historical: Western Front established" }
                ],
                tags: ["wwii", "d-day", "normandy", "allies"],
                color: "#EF4444"
            }
            // Add more events to reach 150+
        ];

        /* --- ENHANCED APP CONTROLLER --- */
        const app = {
            data: historicalEvents,
            filtered: [],
            currentView: 'landing',
            map: null,
            bookmarks: JSON.parse(localStorage.getItem('historyBookmarks')) || [],
            isListening: false,
            recognition: null,
            activeItem: null,

            init: function() {
                this.filtered = [...this.data];
                
                // Loading animation
                this.simulateLoading();
                
                // Initialize components
                setTimeout(() => {
                    this.renderTimeline();
                    this.initMap();
                    this.renderEvents();
                    this.setupObservers();
                    this.updateBookmarksUI();
                    
                    // Setup voice recognition if available
                    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                        this.setupVoiceRecognition();
                    }
                }, 2000);
            },

            simulateLoading: function() {
                const countEl = document.getElementById('stat-count');
                let count = 0;
                const target = 150;
                const interval = setInterval(() => {
                    count += Math.floor(Math.random() * 5) + 1;
                    if(count >= target) {
                        count = target;
                        clearInterval(interval);
                        setTimeout(() => {
                            document.getElementById('loader').style.opacity = '0';
                            setTimeout(() => {
                                document.getElementById('loader').style.display = 'none';
                            }, 800);
                        }, 500);
                    }
                    countEl.innerText = count;
                }, 30);
            },

            view: function(viewName) {
                sfx.click();
                this.currentView = viewName;
                
                // Update navigation
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                const activeBtn = document.querySelector(`.nav-btn[onclick="app.view('${viewName}')"]`);
                if (activeBtn) activeBtn.classList.add('active');
                
                // Show/hide views
                if (viewName === 'landing') {
                    document.getElementById('main-app').classList.add('hidden');
                    document.getElementById('view-landing').classList.remove('hidden');
                } else {
                    document.getElementById('view-landing').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    
                    // Hide all views
                    document.getElementById('view-timeline').classList.add('hidden');
                    document.getElementById('view-map').classList.add('hidden');
                    document.getElementById('view-ai').classList.add('hidden');
                    document.getElementById('view-events').classList.add('hidden');
                    
                    // Show selected view
                    document.getElementById(`view-${viewName}`).classList.remove('hidden');
                    
                    // Initialize view-specific features
                    if(viewName === 'timeline') this.renderTimeline();
                    if(viewName === 'map') this.initMap();
                    if(viewName === 'ai') this.focusAIInput();
                }
            },

            filter: function() {
                const era = document.getElementById('filter-era').value;
                const arc = document.getElementById('filter-arc').value;
                const theme = document.getElementById('filter-theme').value;
                
                this.filtered = this.data.filter(item => {
                    const matchEra = era === 'all' || item.era === era;
                    const matchArc = arc === 'all' || item.arc === arc;
                    const matchTheme = theme === 'all' || item.themes.includes(theme);
                    return matchEra && matchArc && matchTheme;
                });

                if(this.currentView === 'timeline') this.renderTimeline();
                if(this.currentView === 'map') this.updateMap();
                if(this.currentView === 'events') this.renderEvents();
            },

            resetFilters: function() {
                document.getElementById('filter-era').value = 'all';
                document.getElementById('filter-arc').value = 'all';
                document.getElementById('filter-theme').value = 'all';
                this.filter();
            },

            renderTimeline: function() {
                const container = document.getElementById('timeline-container');
                // Clear existing nodes except timeline line
                const nodes = container.querySelectorAll('.event-node');
                nodes.forEach(node => node.remove());
                
                // Sort by year and limit to 20 for performance
                const eventsToShow = [...this.filtered]
                    .sort((a, b) => a.year - b.year)
                    .slice(0, 20);
                
                eventsToShow.forEach((event, index) => {
                    const node = document.createElement('div');
                    node.className = `event-node ${index % 2 === 0 ? 'left' : 'right'}`;
                    node.onmouseenter = sfx.hover;
                    node.onclick = () => this.openModal(event);
                    
                    const tagsHTML = event.tags.map(tag => 
                        `<span class="tag ${tag.includes('wwi') ? 'ww1' : tag.includes('wwii') ? 'ww2' : tag.includes('napoleon') ? 'napoleonic' : tag.includes('cold') ? 'coldwar' : ''}">${tag}</span>`
                    ).join('');
                    
                    node.innerHTML = `
                        <div class="card">
                            <span class="card-year">${event.year}</span>
                            <h3 class="card-title">${event.title}</h3>
                            <p class="card-desc">${event.description}</p>
                            <div class="card-tags">
                                ${tagsHTML}
                                ${event.arc !== 'none' ? `<span class="tag arc">${event.arc} Arc</span>` : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(node);
                });
                
                // Re-observe for animations
                this.setupObservers();
            },

            initMap: function() {
                if (this.map) {
                    this.map.remove();
                }
                
                // Initialize Leaflet map with dark theme
                this.map = L.map('world-map', {
                    zoomControl: false,
                    attributionControl: false
                }).setView([30, 0], 2);
                
                // Dark tile layer
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    maxZoom: 8,
                    minZoom: 2
                }).addTo(this.map);
                
                // Add markers
                this.filtered.forEach(event => {
                    if (event.location && event.location.lat) {
                        const marker = L.circleMarker([event.location.lat, event.location.lng], {
                            color: event.color || '#3B82F6',
                            fillColor: event.color || '#3B82F6',
                            fillOpacity: 0.7,
                            radius: 8
                        }).addTo(this.map);
                        
                        marker.bindPopup(`
                            <div style="padding: 10px;">
                                <strong style="color: ${event.color || '#3B82F6'}">${event.title}</strong><br>
                                <small>${event.year} • ${event.era}</small><br>
                                <p style="margin: 5px 0;">${event.description}</p>
                                <button onclick="app.openModal(${event.id})" style="background: ${event.color || '#3B82F6'}; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-top: 5px;">
                                    View Details
                                </button>
                            </div>
                        `);
                    }
                });
                
                // Draw connections for arcs
                this.drawArcConnections();
            },

            drawArcConnections: function() {
                const arcs = ['Napoleon', 'Hitler', 'Che'];
                
                arcs.forEach(arcName => {
                    const arcEvents = this.filtered
                        .filter(e => e.arc === arcName && e.location)
                        .sort((a, b) => a.year - b.year);
                    
                    if (arcEvents.length > 1) {
                        const latlngs = arcEvents.map(e => [e.location.lat, e.location.lng]);
                        L.polyline(latlngs, {
                            color: arcEvents[0].color,
                            weight: 2,
                            opacity: 0.5,
                            dashArray: '10, 10'
                        }).addTo(this.map);
                    }
                });
            },

            updateMap: function() {
                this.initMap();
            },

            renderEvents: function() {
                const container = document.getElementById('events-grid');
                container.innerHTML = '';
                
                this.filtered.slice(0, 12).forEach(event => {
                    const card = document.createElement('div');
                    card.className = 'event-card';
                    card.onclick = () => this.openModal(event);
                    
                    card.innerHTML = `
                        <div class="event-image" style="background: linear-gradient(45deg, ${event.color}, ${event.color}80);">
                            <div class="event-year">${event.year}</div>
                        </div>
                        <div class="event-content">
                            <h3 style="margin-bottom: 10px; font-family: var(--font-display);">${event.title}</h3>
                            <p style="color: var(--text-dim); margin-bottom: 15px; font-size: 0.95rem;">${event.description}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.8rem; color: ${event.color}; font-family: var(--font-mono);">
                                    ${event.era}
                                </span>
                                <button class="btn-glow" style="padding: 8px 16px; font-size: 0.8rem;" onclick="event.stopPropagation(); app.openModal(${event.id})">
                                    Explore
                                </button>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            },

            setupObservers: function() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if(entry.isIntersecting) {
                            entry.target.classList.add('visible');
                        }
                    });
                }, { threshold: 0.1, rootMargin: "0px 0px -50px 0px" });
                
                document.querySelectorAll('.event-node').forEach(el => observer.observe(el));
            },

            openModal: function(event) {
                sfx.click();
                if (typeof event === 'number') {
                    event = this.data.find(e => e.id === event);
                }
                if (!event) return;
                
                this.activeItem = event;
                const backdrop = document.getElementById('modal-backdrop');
                
                // Set modal content
                document.getElementById('m-title').textContent = event.title;
                document.getElementById('m-year').textContent = event.year;
                document.getElementById('m-era').textContent = event.era;
                document.getElementById('m-arc').textContent = event.arc !== 'none' ? event.arc : 'General History';
                document.getElementById('m-desc').textContent = event.detailed;
                document.getElementById('m-id').textContent = event.id;
                
                // Set data section
                const dataHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>Date:</strong> ${event.date}<br>
                        <strong>Location:</strong> ${event.location?.name || 'Unknown'}<br>
                        <strong>Casualties:</strong> ${event.casualties?.toLocaleString() || 'Unknown'}<br>
                        <strong>Significance:</strong> ${'★'.repeat(event.significance)}<br>
                        <strong>Themes:</strong> ${event.themes.join(', ')}
                    </div>
                `;
                document.getElementById('m-data').innerHTML = dataHTML;
                
                // Set decision points
                const decContainer = document.getElementById('m-decisions');
                const listContainer = document.getElementById('m-dec-list');
                const resultContainer = document.getElementById('m-dec-result');
                
                listContainer.innerHTML = '';
                resultContainer.style.display = 'none';
                resultContainer.innerHTML = '';
                
                if (event.decisionPoints && event.decisionPoints.length > 0) {
                    decContainer.classList.remove('hidden');
                    event.decisionPoints.forEach(point => {
                        const btn = document.createElement('button');
                        btn.className = 'dec-btn';
                        btn.innerHTML = `◈ ${point.title}`;
                        btn.onclick = (e) => {
                            sfx.click();
                            e.stopPropagation();
                            resultContainer.innerHTML = `
                                <strong>ALTERNATIVE OUTCOME:</strong><br>
                                ${point.outcome}<br><br>
                                <small style="color: #888;">Probability: ${Math.floor(Math.random() * 30) + 60}%</small>
                            `;
                            resultContainer.style.display = 'block';
                        };
                        listContainer.appendChild(btn);
                    });
                } else {
                    decContainer.classList.add('hidden');
                }
                
                // Update bookmark button
                const bookmarkBtn = document.getElementById('bookmark-btn');
                const isBookmarked = this.bookmarks.includes(event.id);
                bookmarkBtn.innerHTML = isBookmarked ? 
                    '<i class="fas fa-bookmark"></i> Bookmarked' : 
                    '<i class="far fa-bookmark"></i> Bookmark';
                
                backdrop.classList.add('active');
            },

            closeModal: function(e) {
                if(e.target.id === 'modal-backdrop') {
                    this.forceCloseModal();
                }
            },

            forceCloseModal: function() {
                document.getElementById('modal-backdrop').classList.remove('active');
                window.speechSynthesis.cancel();
            },

            bookmarkEvent: function() {
                if(!this.activeItem) return;
                
                const index = this.bookmarks.indexOf(this.activeItem.id);
                if(index === -1) {
                    this.bookmarks.push(this.activeItem.id);
                    this.showNotification('Event bookmarked!', 'success');
                } else {
                    this.bookmarks.splice(index, 1);
                    this.showNotification('Bookmark removed', 'info');
                }
                
                localStorage.setItem('historyBookmarks', JSON.stringify(this.bookmarks));
                this.updateBookmarksUI();
                
                // Update button
                const bookmarkBtn = document.getElementById('bookmark-btn');
                const isBookmarked = this.bookmarks.includes(this.activeItem.id);
                bookmarkBtn.innerHTML = isBookmarked ? 
                    '<i class="fas fa-bookmark"></i> Bookmarked' : 
                    '<i class="far fa-bookmark"></i> Bookmark';
            },

            updateBookmarksUI: function() {
                // Update bookmark count in navigation
                const bookmarkCount = this.bookmarks.length;
                // You could add a badge to the navigation if desired
            },

            speak: function() {
                if(!this.activeItem) return;
                const text = `${this.activeItem.title}, year ${this.activeItem.year}. ${this.activeItem.description}`;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 0.8;
                utterance.volume = 1;
                
                // Try to find a good voice
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.lang.includes('en') && voice.name.includes('Male')
                );
                if (preferredVoice) utterance.voice = preferredVoice;
                
                window.speechSynthesis.speak(utterance);
            },

            setupVoiceRecognition: function() {
                this.recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                this.recognition.lang = 'en-US';
                this.recognition.interimResults = false;
                this.recognition.maxAlternatives = 1;
                
                this.recognition.onstart = () => {
                    this.isListening = true;
                    document.getElementById('voice-btn').innerHTML = '<i class="fas fa-stop"></i>';
                    this.showNotification('Listening...', 'info');
                };
                
                this.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('ai-input').value = transcript;
                    
                    if (transcript.includes('what if') || transcript.includes('?')) {
                        setTimeout(() => this.askAI(), 500);
                    }
                };
                
                this.recognition.onerror = (event) => {
                    this.showNotification('Voice recognition error: ' + event.error, 'error');
                };
                
                this.recognition.onend = () => {
                    this.isListening = false;
                    document.getElementById('voice-btn').innerHTML = '<i class="fas fa-microphone"></i>';
                };
            },

            toggleVoice: function() {
                if (!this.recognition) {
                    this.showNotification('Voice recognition not supported in your browser', 'error');
                    return;
                }
                
                if (!this.isListening) {
                    this.recognition.start();
                } else {
                    this.recognition.stop();
                }
            },

            askAI: function() {
                const input = document.getElementById('ai-input');
                const log = document.getElementById('ai-log');
                const question = input.value.trim();
                
                if (!question) {
                    this.showNotification('Please enter a question', 'error');
                    return;
                }
                
                // Add user message
                this.addAIMessage(question, 'user');
                input.value = '';
                sfx.type();
                
                // Show thinking indicator
                this.addAIMessage('Analyzing temporal variables...', 'ai');
                
                // AI responses based on question
                const aiResponses = {
                    "what if germany won wwi": "If Germany had won WWI, the Treaty of Versailles would never have been signed. Germany would have established dominance in Central Europe, possibly preventing the rise of Hitler. The Austro-Hungarian and Ottoman Empires might have survived longer. Colonial empires would have been redistributed, and the United States might not have emerged as a superpower. The Russian Revolution might have been suppressed with German support.",
                    "what if napoleon won at waterloo": "If Napoleon won at Waterloo, he might have regained power in France temporarily. However, the European powers would likely have continued their coalition against him. A prolonged war might have exhausted all sides, potentially leading to different borders in Europe. The Congress of Vienna would have been renegotiated, possibly delaying German and Italian unification.",
                    "what if hitler was assassinated": "If Hitler was assassinated early (1939-1940), WWII might have been shorter or avoided. A military junta might have taken control, potentially negotiating peace with the Allies earlier. The Holocaust might have been prevented or minimized. Post-war Europe would have developed along very different lines without the Iron Curtain division.",
                    "what if the library of alexandria never burned": "If the Library of Alexandria survived, scientific progress might have accelerated by centuries. Works by ancient scientists and philosophers would have been preserved, potentially leading to earlier discoveries in mathematics, astronomy, and medicine. The Renaissance might have occurred centuries earlier, and the Scientific Revolution could have begun in the Middle Ages.",
                    "what if the cuban missile crisis escalated": "If the Cuban Missile Crisis escalated to nuclear war, both the US and USSR would have suffered catastrophic losses. Global nuclear winter would have caused worldwide famine. Civilization as we know it might have collapsed, with survivors struggling in a radioactive world. Recovery would have taken centuries."
                };
                
                // Simulate AI processing
                setTimeout(() => {
                    // Remove thinking indicator
                    const messages = log.children;
                    if (messages.length > 0) {
                        log.removeChild(messages[messages.length - 1]);
                    }
                    
                    // Find matching response or generate generic one
                    let response = "I need more specific historical data for that scenario.";
                    const lowerQuestion = question.toLowerCase();
                    
                    for (const [key, value] of Object.entries(aiResponses)) {
                        if (lowerQuestion.includes(key)) {
                            response = value;
                            break;
                        }
                    }
                    
                    // Add AI response with typing effect
                    this.typewriter(log, response);
                    
                    // Auto-speak if it's a significant response
                    if (response.length > 50) {
                        setTimeout(() => this.speakAIResponse(response), 1000);
                    }
                }, 1500 + Math.random() * 1000);
            },

            addAIMessage: function(message, sender) {
                const log = document.getElementById('ai-log');
                const messageDiv = document.createElement('div');
                
                if (sender === 'ai') {
                    messageDiv.innerHTML = `
                        <div style="margin-top: 15px; color: var(--accent-blue);">
                            <strong>TEMPORAL AI:</strong> ${message}
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div style="margin-top: 15px; color: var(--accent-gold);">
                            <strong>USER:</strong> ${message}
                        </div>
                    `;
                }
                
                log.appendChild(messageDiv);
                log.scrollTop = log.scrollHeight;
            },

            typewriter: function(element, text) {
                const div = document.createElement('div');
                div.style.color = 'var(--accent-blue)';
                div.style.marginTop = '15px';
                div.innerHTML = '<strong>TEMPORAL AI:</strong> ';
                element.appendChild(div);
                
                let i = 0;
                const timer = setInterval(() => {
                    div.innerHTML += text.charAt(i);
                    sfx.type();
                    element.scrollTop = element.scrollHeight;
                    i++;
                    if (i >= text.length) {
                        clearInterval(timer);
                    }
                }, 30);
            },

            speakAIResponse: function(text) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.85;
                utterance.pitch = 0.7;
                utterance.volume = 1;
                
                const voices = speechSynthesis.getVoices();
                const aiVoice = voices.find(voice => 
                    voice.lang.includes('en') && voice.name.includes('Microsoft David')
                ) || voices.find(voice => voice.lang.includes('en-US'));
                
                if (aiVoice) utterance.voice = aiVoice;
                window.speechSynthesis.speak(utterance);
            },

            focusAIInput: function() {
                setTimeout(() => {
                    document.getElementById('ai-input').focus();
                }, 100);
            },

            showNotification: function(message, type) {
                // Create notification element
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 30px;
                    padding: 15px 25px;
                    background: ${type === 'error' ? 'var(--accent-red)' : type === 'success' ? 'var(--accent-green)' : 'var(--accent-blue)'};
                    color: white;
                    border-radius: 4px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
                    z-index: 3000;
                    animation: fadeInUp 0.3s ease;
                    font-family: var(--font-mono);
                    font-size: 0.9rem;
                    max-width: 300px;
                    border-left: 4px solid ${type === 'error' ? '#ff0000' : type === 'success' ? '#00ff00' : '#0000ff'};
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.style.animation = 'fadeInUp 0.3s ease reverse';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            },

            // Particle Background (from your code)
            bgCanvas: {
                ctx: null, w: 0, h: 0, particles: [],
                init: function() {
                    const canvas = document.getElementById('bg-canvas');
                    this.ctx = canvas.getContext('2d');
                    this.resize();
                    window.addEventListener('resize', () => this.resize());
                    
                    for(let i = 0; i < 60; i++) {
                        this.particles.push({
                            x: Math.random() * this.w,
                            y: Math.random() * this.h,
                            size: Math.random() * 2 + 1,
                            speed: Math.random() * 0.5 + 0.1,
                            color: Math.random() > 0.5 ? 'rgba(207, 170, 110, 0.5)' : 'rgba(46, 140, 255, 0.5)'
                        });
                    }
                    this.loop();
                },
                resize: function() {
                    const canvas = document.getElementById('bg-canvas');
                    this.w = canvas.width = window.innerWidth;
                    this.h = canvas.height = window.innerHeight;
                },
                loop: function() {
                    const ctx = this.ctx;
                    ctx.clearRect(0, 0, this.w, this.h);
                    
                    this.particles.forEach(p => {
                        p.y -= p.speed;
                        if (p.y < 0) {
                            p.y = this.h;
                            p.x = Math.random() * this.w;
                        }
                        
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        ctx.fillStyle = p.color;
                        ctx.fill();
                        
                        // Glow effect
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size * 3, 0, Math.PI * 2);
                        ctx.fillStyle = p.color.replace('0.5', '0.1');
                        ctx.fill();
                    });
                    
                    requestAnimationFrame(() => this.loop());
                }
            }
        };

        // Initialize app when page loads
        window.addEventListener('load', () => {
            app.init();
            app.bgCanvas.init();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape closes modal
            if (e.key === 'Escape') {
                app.forceCloseModal();
            }
            // Ctrl+K focuses AI input
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                app.view('ai');
            }
        });

        // Initialize speech synthesis voices
        if ('speechSynthesis' in window) {
            speechSynthesis.getVoices(); // Prime the voices
        }
    </script>
</body>
</html>